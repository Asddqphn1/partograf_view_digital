<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Partograf Digital API - Tampilan Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tambahkan library html2pdf -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
      body {
        font-family: "Arial", sans-serif;
      }
      * {
        box-sizing: border-box;
      }

      /* Grid Styling */
      .grid-line {
        stroke: #000;
        stroke-width: 1;
        shape-rendering: crispEdges;
      }
      .grid-line-thick {
        stroke: #000;
        stroke-width: 2;
        shape-rendering: crispEdges;
      }
      .grid-line-major {
        stroke: #000;
        stroke-width: 1.2;
        shape-rendering: crispEdges;
      }
      .grid-line-minor {
        stroke: #9ca3af;
        stroke-width: 0.8;
        shape-rendering: crispEdges;
      }

      /* Typography */
      .label-axis {
        font-size: 10px;
        font-weight: bold;
      }
      .label-waktu {
        font-size: 11px;
        font-weight: bold;
      }
      .data-text {
        font-size: 13px;
        font-weight: bold;
        font-family: sans-serif;
      }

      /* Font tulisan tangan untuk data input & hasil lahir */
      .handwritten {
        font-family: "Verdana", "Segoe UI", sans-serif;
        fill: #0000ff;
        font-weight: 700;
        color: #0000ff;
      }

      /* Layout */
      .main-container {
        width: 1100px;
        margin: 0 auto;
        background: white;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
      }
      .chart-row {
        display: flex;
        width: 100%;
      }
      .y-axis-col {
        flex: none;
        width: 140px;
        border-right: 1px solid #000;
        background: white;
        z-index: 10;
        position: relative;
      }
      .chart-area-col {
        flex: 1;
        position: relative;
      }
      .header-label {
        font-weight: bold;
        color: #1f2937;
        white-space: nowrap;
        font-size: 13px;
      }
      .header-input {
        border-bottom: 1px solid black;
        padding: 0 0.5rem;
        white-space: nowrap;
        font-size: 14px;
      }

      /* Legend & Patterns */
      .legend-box {
        width: 12px;
        height: 12px;
        border: 1px solid black;
        display: inline-block;
        vertical-align: middle;
        margin-right: 4px;
      }

      /* Loader */
      #loading-screen {
        position: fixed;
        inset: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 50;
      }

      /* Tombol Download Floating */
      .fab-download {
        position: fixed;
        bottom: 30px;
        right: 30px;
        background-color: #10b981; /* Green 500 */
        color: white;
        padding: 12px 24px;
        border-radius: 50px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        font-weight: bold;
        cursor: pointer;
        transition: transform 0.2s, background-color 0.2s;
        z-index: 100;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .fab-download:hover {
        background-color: #059669; /* Green 600 */
        transform: scale(1.05);
      }
      .fab-download svg {
        width: 20px;
        height: 20px;
      }

      /* Tombol yang dinonaktifkan */
      .fab-download.disabled {
        background-color: #9ca3af; /* Gray 400 */
        cursor: not-allowed;
        transform: none;
      }

      /* Toast Message */
      #toast-message {
        position: fixed;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 200;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
        max-width: 90%;
        min-width: 300px;
        text-align: center;
        padding: 12px;
        border-radius: 8px;
      }
      .toast-success {
        background-color: #d1fae5;
        border: 1px solid #34d399;
        color: #065f46;
      }
      .toast-error {
        background-color: #fee2e2;
        border: 1px solid #f87171;
        color: #991b1b;
      }

      @page {
        size: A4;
        margin: 0;
      }

      @media print {
        body {
          margin: 0;
        }

        #content-container {
          width: 210mm !important;
          height: 297mm !important;
          overflow: hidden !important;
          page-break-inside: avoid;
          page-break-after: avoid;
        }
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen p-4 overflow-x-auto">
    <div id="loading-screen">
      <div class="text-center">
        <div
          class="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"
        ></div>
        <h2 class="text-xl font-bold text-gray-800">
          Memuat Data Partograf...
        </h2>
        <p class="text-gray-500 text-sm mt-2">Menghubungkan ke API...</p>
      </div>
    </div>

    <div
      id="error-screen"
      class="hidden fixed inset-0 bg-white z-50 flex justify-center items-center"
    >
      <div
        class="text-center max-w-md p-6 bg-red-50 border border-red-200 rounded-lg"
      >
        <h2 class="text-xl font-bold text-red-700 mb-2">Gagal Memuat Data</h2>
        <p id="error-msg" class="text-red-600 text-sm"></p>
      </div>
    </div>

    <!-- PDF Toast/Message Area -->
    <div id="toast-message" class="shadow-xl">
      <p id="toast-text" class="text-sm"></p>
    </div>

    <!-- Tombol Download -->
    <button
      onclick="downloadPDF(this)"
      id="btn-download"
      class="fab-download hidden"
    >
      <svg
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
        ></path>
      </svg>
      Export PDF (A4)
    </button>
    <div
      id="pdf-status"
      class="fab-download hidden disabled"
      style="background-color: #3b82f6; right: 30px; bottom: 30px"
    >
      <div
        class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"
      ></div>
      <span id="status-text">Memproses PDF...</span>
    </div>

    <div class="main-container hidden" id="content-container">
      <div class="p-6 bg-white w-full border-b-2 border-black">
        <div class="flex justify-center mb-6 relative">
          <h1 class="text-2xl font-extrabold uppercase tracking-[0.2em]">
            PARTOGRAF
          </h1>
        </div>
        <div class="flex flex-col gap-4 text-sm w-full">
          <div class="flex items-end w-full">
            <div class="flex items-center flex-none mr-8">
              <span class="header-label w-28">No. Registrasi</span>
              <div class="flex border border-black" id="reg-box"></div>
            </div>
            <div class="flex flex-1 items-end gap-4">
              <div class="flex items-end flex-1">
                <span class="header-label mr-2">Nama Ibu:</span>
                <div class="flex-1 header-input handwritten" id="nama-val">
                  -
                </div>
              </div>
              <div class="flex items-end w-32 flex-none">
                <span class="header-label mr-2">Umur:</span>
                <div
                  class="flex-1 header-input handwritten text-center"
                  id="umur-val"
                >
                  -
                </div>
              </div>
              <div class="flex items-end gap-2 flex-none">
                <div class="flex items-end">
                  <span class="header-label mr-1">G:</span>
                  <div
                    class="border-b border-black w-8 handwritten text-center"
                    id="g-val"
                  >
                    -
                  </div>
                </div>
                <div class="flex items-end">
                  <span class="header-label mr-1">P:</span>
                  <div
                    class="border-b border-black w-8 handwritten text-center"
                    id="p-val"
                  >
                    -
                  </div>
                </div>
                <div class="flex items-end">
                  <span class="header-label mr-1">A:</span>
                  <div
                    class="border-b border-black w-8 handwritten text-center"
                    id="a-val"
                  >
                    -
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="flex items-end w-full">
            <div class="flex items-end flex-none mr-8 w-[350px]">
              <span class="header-label w-28">No. Puskesmas</span>
              <div
                class="flex-1 header-input handwritten"
                id="puskesmas-val"
              ></div>
            </div>
            <div class="flex flex-1 items-end gap-4">
              <div class="flex items-end flex-1">
                <span class="header-label mr-2">Tanggal:</span>
                <div class="flex-1 header-input handwritten" id="tanggal-val">
                  -
                </div>
              </div>
              <div class="flex items-end w-40 flex-none">
                <span class="header-label mr-2">Jam pemeriksaan:</span>
                <div
                  class="flex-1 header-input handwritten text-center"
                  id="jam-val"
                >
                  -
                </div>
              </div>
              <div class="w-[100px]"></div>
            </div>
          </div>
          <div class="flex items-end w-full">
            <div class="flex items-end flex-none mr-8 w-[450px]">
              <span class="header-label w-28">Ketuban Pecah</span
              ><span class="header-label mr-2">Sejak Jam:</span>
              <div class="flex-1 header-input handwritten" id="ketuban-val">
                -
              </div>
            </div>
            <div class="flex items-end flex-1">
              <span class="header-label mr-2">Mules Sejak Jam:</span>
              <div class="flex-1 header-input handwritten" id="mules-val">
                -
              </div>
              <div class="w-[100px]"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="chart-row bg-white">
        <div class="y-axis-col">
          <div
            id="label-djj-area"
            class="relative border-b border-black w-full"
          >
            <div
              class="absolute left-2 top-1/2 -translate-y-1/2 font-bold text-[10px] leading-tight"
            >
              Denyut<br />Jantung<br />Janin<br />( /Menit)
            </div>
            <div
              id="y-axis-djj"
              class="absolute right-0 top-0 w-8 h-full pointer-events-none"
            ></div>
          </div>
          <div
            id="label-middle-area"
            class="relative border-b border-black w-full flex flex-col font-bold text-[10px]"
          >
            <div
              class="flex-1 flex items-center justify-end pr-2 border-b border-gray-300"
            >
              Air Ketuban
            </div>
            <div class="flex-1 flex items-center justify-end pr-2">
              Penyusupan
            </div>
          </div>
          <div
            id="label-cervix-area"
            class="relative w-full border-b border-black"
          >
            <div
              class="absolute -left-8 top-1/2 -translate-y-1/2 -rotate-90 font-bold text-[10px] text-center leading-tight w-64"
            >
              Pembukaan Serviks (cm) beri tanda
              <span class="text-purple-700 text-lg">X</span><br />
              Turunnya Kepala beri tanda
              <span class="text-green-600 text-lg">O</span>
            </div>
            <div
              class="absolute -left-12 top-1/2 -translate-y-1/2 -rotate-90 text-[10px] font-bold text-center w-32"
            >
              Sentimeter (cm)
            </div>
            <div
              class="absolute right-8 top-2 bottom-2 border-l-2 border-t-2 border-b-2 border-black w-2"
            ></div>
            <div
              id="y-axis-cervix"
              class="absolute right-0 top-0 w-8 h-full pointer-events-none"
            ></div>
          </div>
          <div
            id="label-time-area"
            class="w-full flex flex-col justify-end items-end pr-2 pb-2 text-[10px] font-bold border-b border-black"
          >
            <div class="h-[30px] flex items-center">Waktu (Jam)</div>
          </div>
          <div
            id="label-kontraksi-area"
            class="relative w-full border-b border-black flex"
          >
            <div
              class="w-20 pl-2 flex flex-col justify-center gap-1 text-[9px] font-bold"
            >
              <div class="mb-1">Kontraksi<br />tiap<br />10 menit</div>
              <div class="flex items-center">
                <div
                  class="legend-box"
                  style="
                    background-image: radial-gradient(
                      black 1px,
                      transparent 1px
                    );
                    background-size: 3px 3px;
                  "
                ></div>
                < 20
              </div>
              <div class="flex items-center">
                <div
                  class="legend-box"
                  style="
                    background: repeating-linear-gradient(
                      45deg,
                      white,
                      white 2px,
                      black 2px,
                      black 3px
                    );
                  "
                ></div>
                20-40
              </div>
              <div class="flex items-center">
                <div class="legend-box bg-black"></div>
                > 40
              </div>
            </div>
            <div
              class="flex-1 flex flex-col justify-between items-end pr-2 py-0 font-bold text-[10px] relative"
              id="y-axis-kontraksi"
            ></div>
          </div>
          <div
            id="label-obat-area"
            class="relative w-full border-b border-black flex items-center justify-end pr-2 text-[10px] font-bold leading-tight text-right"
          >
            Obat dan<br />cairan IV
          </div>
          <div
            id="label-vitals-area"
            class="relative w-full border-b border-black flex"
          >
            <div
              class="w-16 pl-2 flex flex-col justify-center gap-2 text-[10px] font-bold border-r border-transparent"
            >
              <div class="flex items-center gap-1">
                <span class="text-lg leading-none">•</span> Nadi
              </div>
              <div class="flex items-center gap-1">
                <span class="text-base leading-none">↕</span> Tekanan<br />Darah
              </div>
            </div>
            <div
              class="flex-1 flex flex-col justify-between items-end pr-2 py-0 font-bold text-[10px] relative"
              id="y-axis-vitals"
            ></div>
          </div>
          <div
            id="label-suhu-area"
            class="relative w-full border-b border-black flex items-center justify-end pr-2 text-[10px] font-bold"
          >
            Suhu °C
          </div>
          <div
            id="label-urine-area"
            class="relative w-full flex flex-col font-bold text-[10px]"
          >
            <div class="flex-1 flex items-center justify-end pr-2 relative">
              <span class="absolute left-2 top-1/2 -translate-y-1/2">Urine</span
              >Protein
            </div>
            <div
              class="flex-1 flex items-center justify-end pr-2 border-t border-gray-300"
            >
              Aseton
            </div>
            <div
              class="flex-1 flex items-center justify-end pr-2 border-t border-gray-300"
            >
              Volume
            </div>
          </div>
        </div>

        <div class="chart-area-col">
          <div id="chart-svg-container" class="w-full h-full"></div>
        </div>
      </div>

      <div
        class="bg-gray-50 p-3 border-t border-gray-200 text-center text-xs text-gray-500 version-footer"
      >
        Partograf Digital API v1.6 (Data Kelahiran Lengkap)
      </div>
    </div>

    <script>
      // --- 1. KONFIGURASI TAMPILAN (VIEW) ---
      const TOTAL_CONTAINER_WIDTH = 1100;
      const LEFT_LABEL_WIDTH = 140;
      const CHART_AREA_WIDTH = TOTAL_CONTAINER_WIDTH - LEFT_LABEL_WIDTH;
      const COLS = 16;
      const COL_W = CHART_AREA_WIDTH / COLS;
      const UNIT_W = COL_W / 2;
      const TOP_MARGIN = 15;

      // Konfigurasi Baris (Jumlah baris tetap, tinggi yang berubah)
      const DJJ_STEPS = 12;
      const MID_ROWS = 2;
      const CER_ROWS = 10;
      const KONTRAKSI_ROWS = 5;
      const VITALS_STEPS = 12;
      const URINE_ROWS = 3;

      // Variabel Global untuk Tinggi (Akan diisi oleh fungsi updateDimensions)
      let UNIT_H,
        DJJ_H,
        MID_H,
        CER_H,
        TIME_H,
        KONTRAKSI_H,
        OBAT_H,
        VITALS_H,
        SUHU_H,
        URINE_H,
        TOTAL_H;

      // Fungsi untuk mengatur ulang dimensi (Normal vs Export)
      function updateDimensions(isExport = false) {
        // JIKA EXPORT: Gunakan 19px agar muat 1 halaman A4
        // JIKA NORMAL: Gunakan 30px agar enak dilihat di HP
        UNIT_H = isExport ? 19 : 30;

        // Sesuaikan tinggi area statis juga
        TIME_H = isExport ? 50 : 65;
        OBAT_H = isExport ? 50 : 80;

        // Hitung ulang tinggi area lain
        DJJ_H = DJJ_STEPS * UNIT_H;
        MID_H = MID_ROWS * UNIT_H;
        CER_H = CER_ROWS * UNIT_H;
        KONTRAKSI_H = KONTRAKSI_ROWS * UNIT_H;
        VITALS_H = VITALS_STEPS * UNIT_H;
        SUHU_H = UNIT_H;
        URINE_H = URINE_ROWS * UNIT_H;

        TOTAL_H =
          TOP_MARGIN +
          DJJ_H +
          MID_H +
          CER_H +
          TIME_H +
          KONTRAKSI_H +
          OBAT_H +
          VITALS_H +
          SUHU_H +
          URINE_H;

        // Terapkan tinggi ke elemen HTML Label (Kolom Kiri)
        const setH = (id, val) =>
          (document.getElementById(id).style.height = `${val}px`);
        setH("label-djj-area", DJJ_H + TOP_MARGIN);
        setH("label-middle-area", MID_H);
        setH("label-cervix-area", CER_H);
        setH("label-time-area", TIME_H);
        setH("label-kontraksi-area", KONTRAKSI_H);
        setH("label-obat-area", OBAT_H);
        setH("label-vitals-area", VITALS_H);
        setH("label-suhu-area", SUHU_H);
        setH("label-urine-area", URINE_H);
      }

      // --- 2. LOGIKA API & DATA PROCESSING ---

      let processedData = {
        pasien: {},
        djj: [],
        nadi: [],
        kontraksi: [],
        bp: [],
        pembukaan: [],
        penurunan: [],
        ketuban: [],
        penyusupan: [],
        suhu: [],
        urine: [],
        waktuLabels: {},
        infoLahir: null,
      };

      function getQueryParams() {
        const params = new URLSearchParams(window.location.search);
        return {
          token: params.get("token"),
          no_reg: params.get("no_reg"),
          partograf_id: params.get("partograf_id"),
        };
      }

      async function fetchData() {
        const { token, no_reg, partograf_id } = getQueryParams();

        // Inisialisasi awal dengan ukuran normal
        updateDimensions(false);

        if (!token || !no_reg || !partograf_id) {
          console.warn("Parameter tidak lengkap, memuat dummy data.");
          processApiData(getDummyPasien(), getDummyCatatan());
          finalizeLoad();
          return;
        }

        const headers = {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json",
        };

        try {
          const pasienRes = await fetch(
            `https://restful-api-bmc-production-v2.up.railway.app/api/pasien/${no_reg}/getData`,
            { headers }
          );
          if (!pasienRes.ok) throw new Error("Gagal mengambil data pasien");
          const pasienJson = await pasienRes.json();

          const partografRes = await fetch(
            `https://restful-api-bmc-production-v2.up.railway.app/api/partograf/${partograf_id}/catatan`,
            { headers }
          );
          if (!partografRes.ok)
            throw new Error("Gagal mengambil catatan partograf");
          const partografJson = await partografRes.json();

          processApiData(pasienJson.data, partografJson.data);
          finalizeLoad();
        } catch (err) {
          showError(err.message);
        }
      }

      function finalizeLoad() {
        document.getElementById("loading-screen").style.display = "none";
        document.getElementById("content-container").classList.remove("hidden");
        document.getElementById("btn-download").classList.remove("hidden");
        renderInfo();
        renderChart();
      }

      function showError(msg) {
        document.getElementById("loading-screen").classList.add("hidden");
        document.getElementById("error-screen").classList.remove("hidden");
        document.getElementById("error-msg").innerText = msg;
      }

      // --- DUMMY DATA FOR PREVIEW ---
      function getDummyPasien() {
        return {
          no_reg: "12345678",
          nama: "Ny. Contoh",
          umur: 28,
          gravida: 2,
          paritas: 1,
          abortus: 0,
          persalinan: [
            {
              tanggal_jam_rawat: "2023-10-27T08:00:00",
              tanggal_jam_mules: "2023-10-27T04:00:00",
              ketuban_pecah: true,
              tanggal_jam_ketuban_pecah: "2023-10-27T09:00:00",
              status: "selesai",
              tanggal_jam_waktu_bayi_lahir: "2023-10-27T16:00:00",
              jenis_kelamin: "Laki-laki",
              berat_badan: 3200,
              panjang_badan: 49,
              lingkar_dada: 33,
              lingkar_kepala: 34,
            },
          ],
        };
      }
      function getDummyCatatan() {
        return [
          {
            waktu_catat: "2023-10-27T08:00:00",
            pembukaan_servik: 4,
            penurunan_kepala: 4,
            djj: 140,
            nadi_ibu: 80,
            sistolik: 110,
            diastolik: 70,
            suhu_ibu: 36.5,
            air_ketuban: "J",
            molase: "0",
            kontraksi: [
              {
                waktu_mulai: "2023-10-27T08:00:00",
                waktu_selesai: "2023-10-27T08:00:30",
              },
              {
                waktu_mulai: "2023-10-27T08:00:00",
                waktu_selesai: "2023-10-27T08:00:30",
              },
              {
                waktu_mulai: "2023-10-27T08:00:00",
                waktu_selesai: "2023-10-27T08:00:30",
              },
            ],
          },
          {
            waktu_catat: "2023-10-27T12:00:00",
            pembukaan_servik: 8,
            penurunan_kepala: 2,
            djj: 145,
            nadi_ibu: 84,
            sistolik: 120,
            diastolik: 80,
            suhu_ibu: 36.7,
            air_ketuban: "J",
            molase: "0",
            kontraksi: [
              {
                waktu_mulai: "2023-10-27T08:00:00",
                waktu_selesai: "2023-10-27T08:00:45",
              },
              {
                waktu_mulai: "2023-10-27T08:00:00",
                waktu_selesai: "2023-10-27T08:00:45",
              },
              {
                waktu_mulai: "2023-10-27T08:00:00",
                waktu_selesai: "2023-10-27T08:00:45",
              },
              {
                waktu_mulai: "2023-10-27T08:00:00",
                waktu_selesai: "2023-10-27T08:00:45",
              },
            ],
          },
        ];
      }

      function processApiData(pasien, catatanList) {
        const persalinan = pasien.persalinan[0] || {};
        const formatRawDateTime = (isoString) => {
          if (!isoString) return { date: "-", time: "-" };
          try {
            let separator = "T";
            if (isoString.indexOf("T") === -1) separator = " ";
            const parts = isoString.split(separator);
            const datePart = parts[0];
            const timePart =
              parts.length > 1 && parts[1] ? parts[1].substring(0, 5) : "00:00";
            const [y, m, d] = datePart.split("-");
            const monthNames = [
              "Januari",
              "Februari",
              "Maret",
              "April",
              "Mei",
              "Juni",
              "Juli",
              "Agustus",
              "September",
              "Oktober",
              "November",
              "Desember",
            ];
            let formattedDate = datePart;
            if (y && m && d)
              formattedDate = `${d} ${monthNames[parseInt(m) - 1]} ${y}`;
            return { date: formattedDate, time: timePart };
          } catch (e) {
            return { date: "-", time: "-" };
          }
        };

        const rawatData = formatRawDateTime(persalinan.tanggal_jam_rawat);
        const jamMasukDisplay =
          rawatData.time !== "-" ? `${rawatData.time} WIB` : "-";
        const mulesData = formatRawDateTime(persalinan.tanggal_jam_mules);
        const jamMulesDisplay =
          mulesData.time !== "-" ? `${mulesData.time} WIB` : "-";

        let ketubanDisplay = "-";
        if (persalinan.ketuban_pecah === false) ketubanDisplay = "Belum Pecah";
        else if (
          persalinan.ketuban_pecah === true &&
          persalinan.tanggal_jam_ketuban_pecah
        ) {
          const kRaw = formatRawDateTime(
            persalinan.tanggal_jam_ketuban_pecah
          ).time;
          ketubanDisplay = kRaw !== "-" ? `${kRaw} WIB` : "-";
        }

        processedData.pasien = {
          noRegistrasi: pasien.no_reg,
          nama: pasien.nama,
          umur: `${pasien.umur} th`,
          g: pasien.gravida,
          p: pasien.paritas,
          a: pasien.abortus,
          tanggal: rawatData.date,
          jam: jamMasukDisplay,
          ketuban: ketubanDisplay,
          mules: jamMulesDisplay,
        };

        if (
          persalinan.status === "selesai" &&
          persalinan.tanggal_jam_waktu_bayi_lahir
        ) {
          const lahirInfo = formatRawDateTime(
            persalinan.tanggal_jam_waktu_bayi_lahir
          );
          const val = (v) => (v !== null && v !== undefined ? v : "-");
          processedData.infoLahir = [
            `Tanggal ${lahirInfo.date} pukul ${lahirInfo.time} WIB`,
            `bayi lahir spontan, menangis, jenis kelamin ${val(
              persalinan.jenis_kelamin
            )},`,
            `BB ${val(persalinan.berat_badan)} kg, PB ${val(
              persalinan.panjang_badan
            )} cm, LD ${val(persalinan.lingkar_dada)} cm, LK ${val(
              persalinan.lingkar_kepala
            )} cm`,
          ];
        }

        if (!catatanList) catatanList = [];
        catatanList.sort(
          (a, b) => new Date(a.waktu_catat) - new Date(b.waktu_catat)
        );

        let startTime = null;
        const activePhaseEntry = catatanList.find(
          (c) => c.pembukaan_servik >= 4
        );
        if (activePhaseEntry)
          startTime = new Date(activePhaseEntry.waktu_catat);
        else if (catatanList.length > 0)
          startTime = new Date(catatanList[0].waktu_catat);
        else {
          renderInfo();
          return;
        }

        let initialOpening = activePhaseEntry
          ? activePhaseEntry.pembukaan_servik
          : 4;
        let initialXOffset = Math.max(0, initialOpening - 4);

        catatanList.forEach((c) => {
          if (!c.waktu_catat) return;
          const currTime = new Date(c.waktu_catat);
          const diffMs = currTime - startTime;
          const diffHours = diffMs / (1000 * 60 * 60);
          const chartIndex = initialXOffset + diffHours;

          if (Math.abs(chartIndex - Math.round(chartIndex)) < 0.1) {
            const safeTime = formatRawDateTime(c.waktu_catat).time;
            processedData.waktuLabels[Math.round(chartIndex)] = safeTime;
          }

          if (c.djj) processedData.djj.push({ i: chartIndex, v: c.djj });
          if (c.pembukaan_servik)
            processedData.pembukaan.push({
              i: chartIndex,
              v: c.pembukaan_servik,
            });
          if (c.penurunan_kepala)
            processedData.penurunan.push({
              i: chartIndex,
              v: c.penurunan_kepala,
            });
          if (c.nadi_ibu)
            processedData.nadi.push({ i: chartIndex, v: c.nadi_ibu });
          if (c.sistolik && c.diastolik)
            processedData.bp.push({
              i: chartIndex,
              s: c.sistolik,
              d: c.diastolik,
            });
          if (c.suhu_ibu)
            processedData.suhu.push({ i: chartIndex, v: c.suhu_ibu });
          if (c.air_ketuban)
            processedData.ketuban.push({ i: chartIndex, val: c.air_ketuban });
          if (c.molase)
            processedData.penyusupan.push({ i: chartIndex, val: c.molase });
          if (c.protein)
            processedData.urine.push({
              i: chartIndex,
              type: "protein",
              val: c.protein,
            });
          if (c.aseton)
            processedData.urine.push({
              i: chartIndex,
              type: "aseton",
              val: c.aseton,
            });
          if (c.volume_urine)
            processedData.urine.push({
              i: chartIndex,
              type: "volume",
              val: c.volume_urine,
            });

          let frekuensiFinal = 0;
          let durasiFinal = 0;
          if (
            c.kontraksi_frekuensi !== null &&
            c.kontraksi_frekuensi !== undefined
          ) {
            frekuensiFinal = parseInt(c.kontraksi_frekuensi);
            durasiFinal = c.kontraksi_durasi ? parseInt(c.kontraksi_durasi) : 0;
          } else if (c.kontraksi && c.kontraksi.length > 0) {
            frekuensiFinal = c.kontraksi.length;
            let maxDur = 0;
            c.kontraksi.forEach((k) => {
              const start = new Date(k.waktu_mulai);
              const end = new Date(k.waktu_selesai);
              const dur = (end - start) / 1000;
              if (dur > maxDur) maxDur = dur;
            });
            durasiFinal = maxDur;
          }
          if (frekuensiFinal > 0) {
            processedData.kontraksi.push({
              i: chartIndex,
              f: frekuensiFinal,
              d: durasiFinal,
            });
          }
        });
      }

      function renderInfo() {
        const p = processedData.pasien;
        if (!p.noRegistrasi) return;

        const regBox = document.getElementById("reg-box");
        const finalReg = Array(7).fill("");
        (p.noRegistrasi || "")
          .toString()
          .split("")
          .forEach((c, i) => {
            if (i < 7) finalReg[i] = c;
          });
        regBox.innerHTML = "";
        finalReg.forEach((char) => {
          regBox.innerHTML += `<div class="w-6 h-6 flex items-center justify-center border-r border-black last:border-r-0 bg-gray-50 font-bold text-base">${char}</div>`;
        });

        document.getElementById("nama-val").innerText = p.nama;
        document.getElementById("umur-val").innerText = p.umur;
        document.getElementById("g-val").innerText = p.g;
        document.getElementById("p-val").innerText = p.p;
        document.getElementById("a-val").innerText = p.a;
        document.getElementById("tanggal-val").innerText = p.tanggal;
        document.getElementById("jam-val").innerText = p.jam;
        document.getElementById("ketuban-val").innerText = p.ketuban;
        document.getElementById("mules-val").innerText = p.mules;

        const drawLabels = (id, start, steps, stepVal, offset = 0) => {
          let html = "";
          for (let i = 0; i <= steps; i++) {
            let val = start - i * stepVal;
            let topPos = offset + i * UNIT_H;
            html += `<div class="absolute right-1 font-bold flex items-center justify-end w-full h-4 leading-none text-[10px]" style="top:${topPos}px; transform: translateY(-50%);">${val}</div>`;
          }
          document.getElementById(id).innerHTML = html;
        };
        drawLabels("y-axis-djj", 200, 12, 10, TOP_MARGIN);
        drawLabels("y-axis-cervix", 10, 10, 1, 0);
        drawLabels("y-axis-vitals", 180, 12, 10, 0);

        let konHtml = "";
        for (let i = 0; i < 5; i++) {
          let val = 5 - i;
          let topPos = i * UNIT_H;
          konHtml += `<div class="absolute right-1 font-bold flex items-center justify-end w-full h-4 leading-none text-[10px]" style="top:${topPos}px; transform: translateY(-50%);">${val}</div>`;
        }
        document.getElementById("y-axis-kontraksi").innerHTML = konHtml;
      }

      function renderChart() {
        const d = processedData;
        let svg = `<svg width="${CHART_AREA_WIDTH}" height="${
          TOTAL_H + 50
        }" class="block" style="width:100%;">
                <defs>
                    <pattern id="stripes" patternUnits="userSpaceOnUse" width="4" height="4" patternTransform="rotate(45)"><line x1="0" y1="0" x2="0" y2="4" stroke="#000" stroke-width="1" /></pattern>
                    <pattern id="dots" patternUnits="userSpaceOnUse" width="3" height="3"><circle cx="1.5" cy="1.5" r="0.8" fill="#000" /></pattern>
                    <filter id="bg-text" x="-0.1" y="-0.1" width="1.2" height="1.2">
                        <feFlood flood-color="white" flood-opacity="0.85" result="bg" />
                        <feMerge><feMergeNode in="bg"/><feMergeNode in="SourceGraphic"/></feMerge>
                    </filter>
                </defs>`;

        let currentY = TOP_MARGIN;

        // 1. DJJ
        for (let i = 0; i <= DJJ_STEPS; i++) {
          let val = 200 - i * 10;
          let y = currentY + i * UNIT_H;
          let cls =
            val === 180 || val === 100 ? "grid-line-thick" : "grid-line";
          svg += `<line x1="0" y1="${y}" x2="${CHART_AREA_WIDTH}" y2="${y}" class="${cls}" />`;
        }
        let djjPoints = "";
        d.djj.forEach((item) => {
          let x = item.i * COL_W;
          let y = currentY + ((200 - item.v) / 10) * UNIT_H;
          djjPoints += `${x},${y} `;
          svg += `<circle cx="${x}" cy="${y}" r="3" fill="#2563eb" />`;
        });
        if (djjPoints)
          svg += `<polyline points="${djjPoints}" fill="none" stroke="#2563eb" stroke-width="2" />`;
        currentY += DJJ_H;

        // 2. TENGAH
        svg += `<line x1="0" y1="${currentY}" x2="${CHART_AREA_WIDTH}" y2="${currentY}" class="grid-line-thick" />`;
        for (let i = 1; i <= MID_ROWS; i++) {
          let y = currentY + i * UNIT_H;
          svg += `<line x1="0" y1="${y}" x2="${CHART_AREA_WIDTH}" y2="${y}" class="grid-line" />`;
        }
        d.ketuban.forEach((item) => {
          let x = item.i * COL_W + UNIT_W / 2;
          svg += `<text x="${x}" y="${
            currentY + UNIT_H / 2 + 4
          }" text-anchor="middle" class="data-text text-blue-800">${
            item.val
          }</text>`;
        });
        d.penyusupan.forEach((item) => {
          let x = item.i * COL_W + UNIT_W / 2;
          svg += `<text x="${x}" y="${
            currentY + UNIT_H + UNIT_H / 2 + 4
          }" text-anchor="middle" class="data-text text-blue-800">${
            item.val
          }</text>`;
        });
        currentY += MID_H;

        // 3. SERVIKS
        svg += `<line x1="0" y1="${currentY}" x2="${CHART_AREA_WIDTH}" y2="${currentY}" class="grid-line-thick" />`;
        for (let i = 1; i <= CER_ROWS; i++) {
          let y = currentY + i * UNIT_H;
          svg += `<line x1="0" y1="${y}" x2="${CHART_AREA_WIDTH}" y2="${y}" class="grid-line" />`;
        }
        const getCX = (h) => h * COL_W;
        const getCY = (cm) => currentY + (10 - cm) * UNIT_H;
        svg += `<line x1="${getCX(0)}" y1="${getCY(4)}" x2="${getCX(
          6
        )}" y2="${getCY(10)}" stroke="#eab308" stroke-width="2" />`;
        svg += `<text x="${getCX(2)}" y="${getCY(
          5.8
        )}" font-size="10" font-weight="bold" fill="#ca8a04" transform="rotate(-26 ${getCX(
          2
        )} ${getCY(5.8)})">WASPADA</text>`;
        svg += `<line x1="${getCX(3.5)}" y1="${getCY(4)}" x2="${getCX(
          9.5
        )}" y2="${getCY(10)}" stroke="#dc2626" stroke-width="2" />`;
        svg += `<text x="${getCX(5.5)}" y="${getCY(
          5.8
        )}" font-size="10" font-weight="bold" fill="#dc2626" transform="rotate(-26 ${getCX(
          5.5
        )} ${getCY(5.8)})">BERTINDAK</text>`;

        if (d.infoLahir) {
          let textX = 12 * COL_W;
          let textY = currentY + CER_H / 2;
          svg += `<text x="${textX}" y="${textY}" text-anchor="middle" class="handwritten" font-size="16" filter="url(#bg-text)">`;
          d.infoLahir.forEach((line, index) => {
            let dy = index === 0 ? 0 : 20;
            svg += `<tspan x="${textX}" dy="${dy}">${line}</tspan>`;
          });
          svg += `</text>`;
        }

        let pembukaanPts = "";
        d.pembukaan.forEach((item) => {
          let x = item.i * COL_W;
          let y = getCY(item.v);
          pembukaanPts += `${x},${y} `;
          svg += `<g transform="translate(${x}, ${y})"><line x1="-6" y1="-6" x2="6" y2="6" stroke="purple" stroke-width="3" /><line x1="6" y1="-6" x2="-6" y2="6" stroke="purple" stroke-width="3" /></g>`;
        });
        if (pembukaanPts)
          svg += `<polyline points="${pembukaanPts}" fill="none" stroke="purple" stroke-width="2" />`;

        let penurunanPts = "";
        d.penurunan.forEach((item) => {
          let x = item.i * COL_W;
          let y = getCY(item.v);
          penurunanPts += `${x},${y} `;
          svg += `<circle cx="${x}" cy="${y}" r="5" fill="none" stroke="green" stroke-width="3" />`;
        });
        if (penurunanPts)
          svg += `<polyline points="${penurunanPts}" fill="none" stroke="green" stroke-width="2" stroke-dasharray="4" />`;
        currentY += CER_H;

        // 4. WAKTU
        let timeBottomY = currentY + TIME_H;
        for (let i = 0; i <= COLS; i++) {
          let x = i * COL_W;
          svg += `<line x1="${x}" y1="${TOP_MARGIN}" x2="${x}" y2="${timeBottomY}" class="grid-line-major" />`;
          if (i < COLS) {
            let xHalf = x + UNIT_W;
            svg += `<line x1="${xHalf}" y1="${TOP_MARGIN}" x2="${xHalf}" y2="${timeBottomY}" class="grid-line-minor" />`;
            let boxY = currentY;
            svg += `<rect x="${x}" y="${boxY}" width="${COL_W}" height="${
              TIME_H / 2
            }" fill="white" stroke="black" stroke-width="1"/>`;
            svg += `<rect x="${x}" y="${
              boxY + TIME_H / 2
            }" width="${COL_W}" height="${
              TIME_H / 2
            }" fill="white" stroke="black" stroke-width="1"/>`;
          }
        }
        // Label jam
        const timeBoxH = TIME_H / 2;
        const timeTextY = currentY + timeBoxH + timeBoxH / 2 + 4; // Center di kotak bawah

        for (const [idxStr, val] of Object.entries(d.waktuLabels)) {
          let idx = parseFloat(idxStr);
          let tX = idx * COL_W + COL_W / 2;
          svg += `<text x="${tX}" y="${timeTextY}" text-anchor="middle" class="label-waktu text-blue-800">${val}</text>`;
        }
        for (let i = 0; i < COLS; i++) {
          svg += `<text x="${i * COL_W + COL_W / 2}" y="${
            currentY + timeBoxH / 2 + 4
          }" text-anchor="middle" class="label-waktu">${i + 1}</text>`;
        }
        currentY += TIME_H;

        // 5. KONTRAKSI
        for (let i = 0; i <= KONTRAKSI_ROWS; i++) {
          let y = currentY + i * UNIT_H;
          svg += `<line x1="0" y1="${y}" x2="${CHART_AREA_WIDTH}" y2="${y}" class="grid-line" />`;
        }
        for (let i = 0; i <= COLS; i++) {
          let x = i * COL_W;
          svg += `<line x1="${x}" y1="${currentY}" x2="${x}" y2="${
            currentY + KONTRAKSI_H
          }" class="grid-line-major" />`;
          if (i < COLS) {
            let xHalf = x + UNIT_W;
            svg += `<line x1="${xHalf}" y1="${currentY}" x2="${xHalf}" y2="${
              currentY + KONTRAKSI_H
            }" class="grid-line-minor" />`;
          }
        }
        d.kontraksi.forEach((item) => {
          let kX = item.i * COL_W;
          let kW = UNIT_W;
          let kH = item.f * UNIT_H;
          let kY = currentY + KONTRAKSI_H - kH;
          let fill =
            item.d < 20
              ? "url(#dots)"
              : item.d <= 40
              ? "url(#stripes)"
              : "black";
          svg += `<rect x="${kX}" y="${kY}" width="${kW}" height="${kH}" fill="${fill}" stroke="black" />`;
        });
        currentY += KONTRAKSI_H;

        // 6. OBAT
        svg += `<line x1="0" y1="${currentY}" x2="${CHART_AREA_WIDTH}" y2="${currentY}" class="grid-line-thick" />`;
        svg += `<line x1="0" y1="${
          currentY + OBAT_H
        }" x2="${CHART_AREA_WIDTH}" y2="${
          currentY + OBAT_H
        }" class="grid-line" />`;
        for (let i = 0; i <= COLS; i++) {
          let x = i * COL_W;
          svg += `<line x1="${x}" y1="${currentY}" x2="${x}" y2="${
            currentY + OBAT_H
          }" class="grid-line-major" />`;
        }
        currentY += OBAT_H;

        // 7. VITAL SIGNS
        for (let i = 0; i <= VITALS_STEPS; i++) {
          let val = 180 - i * 10;
          let y = currentY + i * UNIT_H;
          let cls =
            val === 100 || val === 180 ? "grid-line-thick" : "grid-line";
          svg += `<line x1="0" y1="${y}" x2="${CHART_AREA_WIDTH}" y2="${y}" class="grid-line" />`;
        }
        let vitalsBottom = currentY + VITALS_H;
        for (let i = 0; i <= COLS; i++) {
          let x = i * COL_W;
          svg += `<line x1="${x}" y1="${currentY}" x2="${x}" y2="${vitalsBottom}" class="grid-line-major" />`;
          if (i < COLS) {
            let xHalf = x + UNIT_W;
            svg += `<line x1="${xHalf}" y1="${currentY}" x2="${xHalf}" y2="${vitalsBottom}" class="grid-line-minor" />`;
          }
        }
        d.bp.forEach((item) => {
          let x = item.i * COL_W;
          let sysY = currentY + ((180 - item.s) / 10) * UNIT_H;
          let diaY = currentY + ((180 - item.d) / 10) * UNIT_H;
          svg += `<line x1="${x}" y1="${sysY}" x2="${x}" y2="${diaY}" stroke="blue" stroke-width="2" />`;
          svg += `<path d="M${x - 4},${sysY + 6} L${x},${sysY} L${x + 4},${
            sysY + 6
          }" fill="none" stroke="blue" stroke-width="2" />`;
          svg += `<path d="M${x - 4},${diaY - 6} L${x},${diaY} L${x + 4},${
            diaY - 6
          }" fill="none" stroke="blue" stroke-width="2" />`;
        });
        let nadiPts = "";
        d.nadi.forEach((item) => {
          let x = item.i * COL_W;
          let y = currentY + ((180 - item.v) / 10) * UNIT_H;
          nadiPts += `${x},${y} `;
          svg += `<circle cx="${x}" cy="${y}" r="3" fill="black" />`;
        });
        if (nadiPts)
          svg += `<polyline points="${nadiPts.trim()}" fill="none" stroke="black" stroke-width="1.5" />`;
        currentY += VITALS_H;

        // 8. SUHU & 9. URINE
        let totalBottomH = SUHU_H + URINE_ROWS * UNIT_H;
        svg += `<line x1="0" y1="${currentY}" x2="${CHART_AREA_WIDTH}" y2="${currentY}" class="grid-line-thick" />`;
        for (let i = 0; i <= COLS; i++) {
          let x = i * COL_W;
          svg += `<line x1="${x}" y1="${currentY}" x2="${x}" y2="${
            currentY + totalBottomH
          }" class="grid-line-major" />`;
        }
        for (let i = 1; i <= 1 + URINE_ROWS; i++) {
          let y = currentY + i * UNIT_H;
          svg += `<line x1="0" y1="${y}" x2="${CHART_AREA_WIDTH}" y2="${y}" class="grid-line" />`;
        }
        d.suhu.forEach((item) => {
          let x = item.i * COL_W + COL_W / 2;
          svg += `<text x="${x}" y="${
            currentY + UNIT_H / 2 + 4
          }" text-anchor="middle" class="data-text text-blue-800">${
            item.v
          }</text>`;
        });
        d.urine.forEach((item) => {
          let uY = currentY + SUHU_H;
          let x = item.i * COL_W + COL_W / 2;
          if (item.type === "protein")
            svg += `<text x="${x}" y="${
              uY + 0.5 * UNIT_H + 4
            }" text-anchor="middle" class="data-text text-blue-800">${
              item.val
            }</text>`;
          if (item.type === "aseton")
            svg += `<text x="${x}" y="${
              uY + 1.5 * UNIT_H + 4
            }" text-anchor="middle" class="data-text text-blue-800">${
              item.val
            }</text>`;
          if (item.type === "volume")
            svg += `<text x="${x}" y="${
              uY + 2.5 * UNIT_H + 4
            }" text-anchor="middle" class="data-text text-blue-800">${
              item.val
            }</text>`;
        });

        svg += `</svg>`;
        document.getElementById("chart-svg-container").innerHTML = svg;
      }

      function showToast(message, isSuccess = false) {
        const toast = document.getElementById("toast-message");
        const toastText = document.getElementById("toast-text");
        toast.classList.remove("toast-success", "toast-error", "opacity-0");
        toast.classList.add(
          isSuccess ? "toast-success" : "toast-error",
          "opacity-100"
        );
        toastText.innerText = message;
        toast.style.opacity = 1;
        toast.style.pointerEvents = "auto";
        setTimeout(() => {
          toast.style.opacity = 0;
          toast.style.pointerEvents = "none";
        }, 5000);
      }

      function sendPdfToNative(base64Data, filename) {
        if (
          window.ReactNativeWebView &&
          window.ReactNativeWebView.postMessage
        ) {
          const message = JSON.stringify({
            action: "EXPORT_PDF",
            filename: filename,
            data: base64Data,
          });
          window.ReactNativeWebView.postMessage(message);
        } else {
          console.error(
            "ReactNativeWebView bridge is missing. Export aborted."
          );
          showToast("Error Bridge: WebView bridge tidak tersedia.", false);
          document.getElementById("pdf-status").classList.add("hidden");
          document.getElementById("btn-download").classList.remove("hidden");
          // Kembalikan ukuran ke normal jika error
          updateDimensions(false);
          renderInfo();
          renderChart();
        }
      }

      window.addEventListener("message", (event) => {
        let data;
        try {
          if (
            typeof event.data !== "string" ||
            !event.data.startsWith('{"action":')
          )
            return;
          data = JSON.parse(event.data);
        } catch (e) {
          return;
        }

        if (data.action === "PDF_SHARED") {
          document.getElementById("pdf-status").classList.add("hidden");
          document.getElementById("btn-download").classList.remove("hidden");
          showToast("PDF berhasil diproses.", true);
          // KEMBALIKAN UKURAN KE NORMAL SETELAH SUKSES
          updateDimensions(false);
          renderInfo();
          renderChart();
        } else if (data.action === "PDF_ERROR") {
          document.getElementById("pdf-status").classList.add("hidden");
          document.getElementById("btn-download").classList.remove("hidden");
          showToast(`Gagal: ${data.message || "Error"}`, false);
          // KEMBALIKAN UKURAN KE NORMAL SETELAH ERROR
          updateDimensions(false);
          renderInfo();
          renderChart();
        }
      });

      async function downloadPDF(button) {
        if (button.classList.contains("disabled")) return;

        // 1. UBAH KE MODE KOMPAK (A4)
        updateDimensions(true);
        renderInfo();
        renderChart();

        // Tunggu sebentar agar DOM ter-render sempurna
        await new Promise((r) => setTimeout(r, 500));

        button.classList.add("hidden");
        document.getElementById("pdf-status").classList.remove("hidden");
        document.getElementById("status-text").innerText = "Memproses PDF...";

        try {
          const element = document.getElementById("content-container");

          // LOGIKA NAMA FILE DINAMIS
          let rawName = processedData.pasien.nama || "Pasien";
          let rawNoReg = processedData.pasien.noRegistrasi || "000";
          let cleanName = rawName.replace(/[^a-zA-Z0-9]/g, "_");
          let cleanNoReg = rawNoReg.replace(/[^a-zA-Z0-9]/g, "");
          const filename = `Partograf_${cleanName}_${cleanNoReg}.pdf`;

          element.style.width = "210mm";
          element.style.height = "297mm";
          element.style.overflow = "hidden";

          const opt = {
            margin: 0,
            filename: filename,
            image: { type: "jpeg", quality: 0.98 },

            html2canvas: {
              scale: 1, // ⬅️ PENTING (2 bikin kepanjangan)
              useCORS: true,
              scrollY: 0,
              windowWidth: 1100, // ⬅️ samakan dengan main-container
            },

            jsPDF: {
              unit: "mm",
              format: "a4",
              orientation: "portrait",
            },

            pagebreak: {
              mode: ["avoid-all"],
            },
          };

          const pdfDataUri = await html2pdf()
            .set(opt)
            .from(element)
            .output("datauristring");
          const base64Data = pdfDataUri.split(",")[1];

          sendPdfToNative(base64Data, filename);

          // Note: updateDimensions(false) dipanggil di event listener message
          // agar tampilan tidak berubah sebelum native selesai memproses file.
        } catch (err) {
          console.error("PDF Export Error:", err);
          showToast(`Gagal generate PDF: ${err.message}`, false);
          document.getElementById("pdf-status").classList.add("hidden");
          button.classList.remove("hidden");

          // Kembalikan ke normal jika error di blok ini
          updateDimensions(false);
          renderInfo();
          renderChart();
        }
      }

      fetchData();
    </script>
  </body>
</html>
